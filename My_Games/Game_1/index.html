<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Tic-Tac-Toe - Unbeatable</title>
    <style>
        /* --- CSS STYLES --- */
        body {
            background-color: #222;
            color: white;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            text-align: center;
            margin: 0;
            padding-top: 20px;
        }

        /* Navigation Back Button */
        .nav-bar {
            text-align: left;
            padding: 0 20px;
        }
        .back-link {
            color: #00ffcc;
            text-decoration: none;
            border: 1px solid #00ffcc;
            padding: 8px 15px;
            border-radius: 5px;
            font-size: 14px;
            transition: 0.3s;
        }
        .back-link:hover {
            background-color: #00ffcc;
            color: black;
        }

        h1 { margin-bottom: 10px; }

        /* Controls Area */
        .controls {
            margin: 20px auto;
            padding: 15px;
            background: #333;
            display: inline-block;
            border-radius: 10px;
        }

        select {
            padding: 8px;
            font-size: 16px;
            border-radius: 5px;
            cursor: pointer;
        }

        /* Scoreboard */
        .scoreboard {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 20px;
            font-size: 18px;
            font-weight: bold;
        }
        .score-box {
            background: #444;
            padding: 10px 20px;
            border-radius: 8px;
            border: 2px solid #555;
        }

        /* The Game Board */
        .board {
            display: grid;
            grid-template-columns: repeat(3, 100px);
            grid-template-rows: repeat(3, 100px);
            gap: 5px;
            margin: 0 auto;
            width: 310px;
        }

        .cell {
            width: 100px;
            height: 100px;
            background-color: #1a1a1a;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3em;
            cursor: pointer;
            border: 2px solid #444;
            color: white;
        }

        .cell:hover { background-color: #333; }
        .cell.x { color: #ff4d4d; } /* Red for User */
        .cell.o { color: #4d94ff; } /* Blue for Computer */

        .status-msg {
            margin-top: 20px;
            font-size: 1.2em;
            height: 30px;
            color: #00ffcc;
        }

        button.reset-btn {
            margin-top: 20px;
            padding: 10px 20px;
            background-color: #e94560;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
        }
        button.reset-btn:hover { background-color: #ff2e4d; }
    </style>
</head>
<body>

    <div class="nav-bar">
        <a href="../../index.html" class="back-link">‚Üê Back to Arcade</a>
    </div>

    <h1>Master Tic-Tac-Toe</h1>

    <div class="controls">
        <label for="difficulty">Difficulty: </label>
        <select id="difficulty" onchange="changeDifficulty()">
            <option value="super-easy">Super Easy</option>
            <option value="easy">Easy</option>
            <option value="medium">Medium</option>
            <option value="hard">Hard</option>
            <option value="impossible">Impossible</option>
        </select>
    </div>

    <div class="scoreboard">
        <div class="score-box">You: <span id="user-score">0</span></div>
        <div class="score-box">Computer: <span id="comp-score">0</span></div>
    </div>

    <div class="status-msg" id="status">Your Turn (X)</div>

    <div class="board" id="board">
        <div class="cell" onclick="makeMove(0)"></div>
        <div class="cell" onclick="makeMove(1)"></div>
        <div class="cell" onclick="makeMove(2)"></div>
        <div class="cell" onclick="makeMove(3)"></div>
        <div class="cell" onclick="makeMove(4)"></div>
        <div class="cell" onclick="makeMove(5)"></div>
        <div class="cell" onclick="makeMove(6)"></div>
        <div class="cell" onclick="makeMove(7)"></div>
        <div class="cell" onclick="makeMove(8)"></div>
    </div>

    <button class="reset-btn" onclick="resetGame()">Restart Game</button>

    <script>
        const boardElement = document.getElementById('board');
        const statusElement = document.getElementById('status');
        const userScoreEl = document.getElementById('user-score');
        const compScoreEl = document.getElementById('comp-score');
        const difficultySelect = document.getElementById('difficulty');

        let board = ['', '', '', '', '', '', '', '', ''];
        let gameActive = true;
        const USER = 'X';
        const COMP = 'O';
        
        // Load scores from storage or start fresh
        let scores = JSON.parse(localStorage.getItem('tictactoe_scores')) || {
            'super-easy': { user: 0, comp: 0 },
            'easy': { user: 0, comp: 0 },
            'medium': { user: 0, comp: 0 },
            'hard': { user: 0, comp: 0 },
            'impossible': { user: 0, comp: 0 }
        };

        // Initialize display
        updateScoreDisplay();

        function changeDifficulty() {
            resetGame();
            updateScoreDisplay(); // Update scoreboard to show stats for NEW difficulty
        }

        function updateScoreDisplay() {
            const level = difficultySelect.value;
            userScoreEl.innerText = scores[level].user;
            compScoreEl.innerText = scores[level].comp;
        }

        function saveScores() {
            localStorage.setItem('tictactoe_scores', JSON.stringify(scores));
        }

        function makeMove(index) {
            if (board[index] !== '' || !gameActive) return;

            // 1. User Move
            updateBoard(index, USER);

            // 2. Check if User Won
            if (checkWin(board, USER)) {
                endGame('You Win!');
                scores[difficultySelect.value].user++;
                saveScores();
                updateScoreDisplay();
                return;
            }
            if (checkDraw(board)) {
                endGame("It's a Draw!");
                return;
            }

            // 3. Computer Move (with slight delay for realism)
            statusElement.innerText = "Computer is thinking...";
            gameActive = false; // Stop user from clicking while computer thinks

            setTimeout(() => {
                if (!gameActive && statusElement.innerText !== "Computer is thinking...") return; // Safety check
                
                const compIndex = getComputerMove();
                updateBoard(compIndex, COMP);

                if (checkWin(board, COMP)) {
                    endGame('Computer Wins!');
                    scores[difficultySelect.value].comp++;
                    saveScores();
                    updateScoreDisplay();
                } else if (checkDraw(board)) {
                    endGame("It's a Draw!");
                } else {
                    gameActive = true;
                    statusElement.innerText = "Your Turn (X)";
                }
            }, 600);
        }

        function updateBoard(index, player) {
            board[index] = player;
            const cell = document.getElementsByClassName('cell')[index];
            cell.innerText = player;
            cell.classList.add(player.toLowerCase());
        }

        function getComputerMove() {
            const level = difficultySelect.value;
            const emptyIndices = board.map((v, i) => v === '' ? i : null).filter(v => v !== null);
            
            // Chance to play perfectly (Impossible move) vs Random move
            let accuracy = 0; 
            
            switch(level) {
                case 'super-easy': accuracy = 0; break;    // 100% Random
                case 'easy':       accuracy = 0.25; break; // 25% Smart
                case 'medium':     accuracy = 0.50; break; // 50% Smart
                case 'hard':       accuracy = 0.85; break; // 85% Smart
                case 'impossible': accuracy = 1; break;    // 100% Smart (Minimax)
            }

            const shouldPlaySmart = Math.random() < accuracy;

            if (shouldPlaySmart) {
                // Run Minimax Algorithm to find best move
                return minimax(board, COMP).index;
            } else {
                // Pick random available spot
                return emptyIndices[Math.floor(Math.random() * emptyIndices.length)];
            }
        }

        // --- MINIMAX ALGORITHM (The "Impossible" Logic) ---
        function minimax(newBoard, player) {
            const availSpots = newBoard.map((v, i) => v === '' ? i : null).filter(v => v !== null);

            // Check terminal states (someone won or draw)
            if (checkWin(newBoard, USER)) return { score: -10 };
            if (checkWin(newBoard, COMP)) return { score: 10 };
            if (availSpots.length === 0) return { score: 0 };

            const moves = [];

            for (let i = 0; i < availSpots.length; i++) {
                const move = {};
                move.index = availSpots[i];
                newBoard[availSpots[i]] = player; // Place temp marker

                if (player === COMP) {
                    const result = minimax(newBoard, USER);
                    move.score = result.score;
                } else {
                    const result = minimax(newBoard, COMP);
                    move.score = result.score;
                }

                newBoard[availSpots[i]] = ''; // Undo temp marker
                moves.push(move);
            }

            let bestMove;
            if (player === COMP) {
                let bestScore = -10000;
                for (let i = 0; i < moves.length; i++) {
                    if (moves[i].score > bestScore) {
                        bestScore = moves[i].score;
                        bestMove = i;
                    }
                }
            } else {
                let bestScore = 10000;
                for (let i = 0; i < moves.length; i++) {
                    if (moves[i].score < bestScore) {
                        bestScore = moves[i].score;
                        bestMove = i;
                    }
                }
            }

            return moves[bestMove];
        }

        // --- HELPER FUNCTIONS ---
        function checkWin(currentBoard, player) {
            const winCombos = [
                [0, 1, 2], [3, 4, 5], [6, 7, 8], // Rows
                [0, 3, 6], [1, 4, 7], [2, 5, 8], // Cols
                [0, 4, 8], [2, 4, 6]             // Diagonals
            ];
            return winCombos.some(combo => {
                return combo.every(index => currentBoard[index] === player);
            });
        }

        function checkDraw(currentBoard) {
            return currentBoard.every(cell => cell !== '');
        }

        function endGame(message) {
            gameActive = false;
            statusElement.innerText = message;
        }

        function resetGame() {
            board = ['', '', '', '', '', '', '', '', ''];
            gameActive = true;
            statusElement.innerText = "Your Turn (X)";
            
            const cells = document.getElementsByClassName('cell');
            for (let cell of cells) {
                cell.innerText = '';
                cell.classList.remove('x', 'o');
            }
        }
    </script>
</body>
</html>